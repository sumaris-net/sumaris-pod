<?xml version="1.0" encoding="UTF-8"?>
<!--
  #%L
  Dali :: Core
  %%
  Copyright (C) 2017 Ifremer
  %%
  This program is free software: you can redistribute it and/or modify
  it under the terms of the GNU Affero General Public License as published by
  the Free Software Foundation, either version 3 of the License, or
  (at your option) any later version.
  
  This program is distributed in the hope that it will be useful,
  but WITHOUT ANY WARRANTY; without even the implied warranty of
  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  GNU General Public License for more details.
  
  You should have received a copy of the GNU Affero General Public License
  along with this program.  If not, see <http://www.gnu.org/licenses/>.
  #L%
  -->

<queries name="extractionCreateSurvivalTestTable">

  <query type="create" temp="false" table="&amp;survivalTestTableName">

    <with alias="SAMPLE_WITH_MEAS">
      <subquery>
        <subselect alias="STATION_NUMBER" type="number">S.STATION_NUMBER</subselect>
        <subselect alias="ID" type="number">SA.ID</subselect>
        <subselect alias="SAMPLE_DATE" type="date">SA.SAMPLE_DATE</subselect>
        <subselect alias="REFERENCE_TAXON_FK" type="text">SA.REFERENCE_TAXON_FK</subselect>
        <subselect alias="TAXON_GROUP_FK" type="text">SA.TAXON_GROUP_FK</subselect>
        <subselect alias="PMFM_FK" type="number">SM.PMFM_FK</subselect>
        <subselect alias="ALPHA_VALUE" type="text">COALESCE(SQV.LABEL, SM.ALPHANUMERICAL_VALUE)</subselect>
        <subselect alias="NUM_VALUE" type="number">SM.NUMERICAL_VALUE</subselect>

        <from alias="S">&amp;stationTableName</from>
        <from join="true">INNER JOIN SAMPLE SA ON SA.OPERATION_FK = S.STATION_NUMBER AND SA.LABEL LIKE UPPER('SAMPLE#%')</from>
        <from join="true">INNER JOIN SAMPLE_MEASUREMENT  SM ON SM.SAMPLE_FK = SA.ID</from>
        <from join="true">LEFT OUTER JOIN QUALITATIVE_VALUE SQV ON SQV.ID=SM.QUALITATIVE_VALUE_FK</from>

        <union>
          <subquery>
            <subselect alias="STATION_NUMBER" type="number">S.STATION_NUMBER</subselect>
            <subselect alias="ID" type="number">PARENT_SA.ID</subselect>
            <subselect alias="SAMPLE_DATE" type="date">PARENT_SA.SAMPLE_DATE</subselect>
            <subselect alias="REFERENCE_TAXON_FK" type="text">PARENT_SA.REFERENCE_TAXON_FK</subselect>
            <subselect alias="TAXON_GROUP_FK" type="text">PARENT_SA.TAXON_GROUP_FK</subselect>
            <subselect alias="PMFM_FK" type="number">SM.PMFM_FK</subselect>
            <subselect alias="ALPHA_VALUE" type="text">COALESCE(SQV.LABEL, SM.ALPHANUMERICAL_VALUE)</subselect>
            <subselect alias="NUM_VALUE" type="number">SM.NUMERICAL_VALUE</subselect>

            <from alias="S">&amp;stationTableName</from>
            <from join="true">INNER JOIN SAMPLE PARENT_SA ON PARENT_SA.OPERATION_FK = S.STATION_NUMBER AND PARENT_SA.LABEL LIKE UPPER('SAMPLE#%')</from>
            <from join="true">INNER JOIN SAMPLE SA ON SA.PARENT_SAMPLE_FK = PARENT_SA.ID AND SA.LABEL LIKE UPPER('INDIVIDUAL_MONITORING#%')</from>
            <from join="true">INNER JOIN SAMPLE_MEASUREMENT  SM ON SM.SAMPLE_FK = SA.ID</from>
            <from join="true">LEFT OUTER JOIN QUALITATIVE_VALUE SQV ON SQV.ID=SM.QUALITATIVE_VALUE_FK</from>
          </subquery>
        </union>
      </subquery>
    </with>
    <!-- PK -->
    <select alias="RECORD_TYPE" type="text">UPPER('ST')</select>
    <select alias="SAMPLING_TYPE" type="text">S.SAMPLING_TYPE</select>
    <select alias="LANDING_COUNTRY" type="text">S.LANDING_COUNTRY</select>
    <select alias="VESSEL_FLAG_COUNTRY" type="text">S.VESSEL_FLAG_COUNTRY</select>
    <select alias="YEAR" type="number">S.YEAR</select>
    <select alias="PROJECT" type="text">S.PROJECT</select>
    <select alias="TRIP_CODE" type="number">S.TRIP_CODE</select>
    <select alias="STATION_NUMBER" type="number">S.STATION_NUMBER</select>
    <select alias="INDIVIDUAL_ID" type="hidden">T.ID</select> <!-- hidden column -->

    <!-- SURVIVAL TEST -->
    <select alias="SPECIES_CODE" type="number">COALESCE(TN.LABEL, TG.LABEL)</select>
    <select alias="SPECIES_NAME" type="number">COALESCE(TN.NAME, TG.NAME)</select>
    <select alias="SAMPLE_DATE" type="number">T.SAMPLE_DATE</select>

    <from alias="S">&amp;stationTableName</from>
    <from join="true">INNER JOIN SAMPLE_WITH_MEAS T ON T.STATION_NUMBER = S.STATION_NUMBER</from>
    <from join="true">LEFT OUTER JOIN TAXON_NAME TN ON TN.REFERENCE_TAXON_FK = T.REFERENCE_TAXON_FK AND TN.IS_REFERENT=true</from>
    <from join="true">LEFT OUTER JOIN TAXON_GROUP TG ON TG.ID = T.TAXON_GROUP_FK</from>

    <groupby>
      RECORD_TYPE, SAMPLING_TYPE, LANDING_COUNTRY, VESSEL_FLAG_COUNTRY, YEAR, PROJECT, TRIP_CODE, S.STATION_NUMBER,
      T.ID, SPECIES_CODE, SPECIES_NAME, T.SAMPLE_DATE
    </groupby>
  </query>

</queries>
