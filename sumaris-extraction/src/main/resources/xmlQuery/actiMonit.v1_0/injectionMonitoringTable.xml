<?xml version="1.0" encoding="UTF-8"?>
<!--
  #%L
  Dali :: Core
  %%
  Copyright (C) 2017 Ifremer
  %%
  This program is free software: you can redistribute it and/or modify
  it under the terms of the GNU Affero General Public License as published by
  the Free Software Foundation, either version 3 of the License, or
  (at your option) any later version.

  This program is distributed in the hope that it will be useful,
  but WITHOUT ANY WARRANTY; without even the implied warranty of
  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  GNU General Public License for more details.

  You should have received a copy of the GNU Affero General Public License
  along with this program.  If not, see <http://www.gnu.org/licenses/>.
  #L%
  -->

<query type="select" temp="false">

    <select alias="ID" type="number">ACTIVITY_CALENDAR.ID</select>
    <select alias="LABEL" type="text">QUALITATIVE_VALUE.LABEL</select>
    <from join="true">
        INNER JOIN
        (
        SELECT VESSEL_FEATURES.VESSEL_FK, MAX(VESSEL_FEATURES.START_DATE) AS MAX_START_DATE GROUP BY
        VESSEL_FEATURES.VESSEL_FK
        )
        AS VESSEL_FEATURES_MAX_DATE
        ON ACTIVITY_CALENDAR.VESSEL_FK = VESSEL_FEATURES_MAX_DATE.VESSEL_FK
    </from>
    <from join="true">
        INNER JOIN VESSEL_FEATURES
        ON
        VESSEL_FEATURES.VESSEL_FK = VESSEL_FEATURES_MAX_DATE.VESSEL_FK
        AND VESSEL_FEATURES.START_DATE = VESSEL_FEATURES_MAX_DATE.MAX_START_DATE
    </from>
    <from join="true">
        INNER JOIN
        (
        SELECT VESSEL_FK, MAX(START_DATE) AS MAX_START_DATE FROM VESSEL_REGISTRATION_PERIOD GROUP BY
        VESSEL_REGISTRATION_PERIOD.VESSEL_FK
        )
        AS
        VESSEL_REGISTRATION_PERIOD_MAX_DATE ON ACTIVITY_CALENDAR.VESSEL_FK =
        VESSEL_REGISTRATION_PERIOD_MAX_DATE.VESSEL_FK
    </from>
    <from join="true">
        INNER JOIN VESSEL_REGISTRATION_PERIOD ON VESSEL_REGISTRATION_PERIOD.VESSEL_FK =
        VESSEL_REGISTRATION_PERIOD_MAX_DATE.VESSEL_FK
        AND VESSEL_REGISTRATION_PERIOD.START_DATE = VESSEL_REGISTRATION_PERIOD_MAX_DATE.MAX_START_DATE
    </from>
    <from join="true">
        INNER JOIN LOCATION ON LOCATION.ID = VESSEL_REGISTRATION_PERIOD.REGISTRATION_LOCATION_FK
    </from>
    <from join="true">
        INNER JOIN SURVEY_MEASUREMENT ON SURVEY_MEASUREMENT.ACTIVITY_CALENDAR_FK = ACTIVITY_CALENDAR.ID
        AND
        SURVEY_MEASUREMENT.PMFM_FK =
        (
        SELECT
        DISTINCT ID
        FROM
        PMFM
        WHERE
        LABEL = &amp;surveyQualification
        )
    </from>
    <from join="true">
        INNER JOIN QUALITATIVE_VALUE ON QUALITATIVE_VALUE.ID = SURVEY_MEASUREMENT.QUALITATIVE_VALUE_FK
    </from>
    <from join="true">
        INNER JOIN GEAR_USE_FEATURES ON GEAR_USE_FEATURES.ACTIVITY_CALENDAR_FK = ACTIVITY_CALENDAR.ID
    </from>
</query>
