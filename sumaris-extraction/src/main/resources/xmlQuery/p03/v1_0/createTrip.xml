<?xml version="1.0" encoding="UTF-8"?>
<queries name="selectTrip">
    <query type="select">
        <select type="text">ID_MAREE</select>
        <select type="text">id_observation</select>
        <select type="text">annee</select>
        <select type="text">trimestre</select>
        <select type="text">mois</select>
        <select type="text">programme</select>
        <select type="text">navire</select>
        <select type="text">immatriculation</select>
        <select type="text">type_navire</select>
        <select type="text">date_depart</select>
        <select type="text">date_retour</select>
        <select type="text">date_debarq</select>
        <select type="text">portdep_typ</select>
        <select type="text">portdep_cod</select>
        <select type="text">portdep_lib</select>
        <select type="text">portret_typ</select>
        <select type="text">portret_cod</select>
        <select type="text">portret_lib</select>
        <select type="text">portdeb_typ</select>
        <select type="text">portdeb_cod</select>
        <select type="text">portdeb_lib</select>
        <select type="text">quartier_cod</select>
        <select type="text">quartier_lib</select>
        <select type="text">atelier_cod</select>
        <select type="text">atelier_lib</select>
        <select type="text">duree_maree_jour</select>
        <select type="text">duree_maree_heure</select>
        <select type="text">NB_HOMME</select>
        <select type="text" alias="TIME_FISHING">MAX(TIME_FISHING)</select>
        <select type="text" alias="NB_GEAR">MAX(NB_GEAR)</select>
        <select type="text" alias="NB_HOOK">MAX(NB_HOOK)</select>
        <select type="text">DOC_DECL</select>
        <select type="text">ETAT_MER</select>
        <select type="text">metier_cod_m</select>
        <select type="text">metier_lib_m</select>
        <select type="text">engin_cod_m</select>
        <select type="text">esp_cible_cod_m</select>
        <select type="text">secteur_cod_m</select>
        <select type="text">secteur_lib_m</select>
        <select type="text">grad_dist_id_m</select>
        <select type="text">grad_dist_lib_m</select>
        <select type="text">grad_dist_ord_m</select>
        <select type="text">grad_prof_id_m</select>
        <select type="text">grad_prof_lib_m</select>
        <select type="text">grad_prof_ord_m</select>
        <select type="text">grad_prox_id_m</select>
        <select type="text">grad_prox_lib_m</select>
        <select type="text">grad_prox_desc_m</select>
        <select type="text">commentaires</select>
        <select type="text">saisisseur_cod</select>
        <select type="text">saisisseur_lib</select>
        <select type="text">date_saisie</select>
        <select type="text">ENQ_QUALIF_LIB</select>
        <select type="text">enq_orig_cod</select>
        <select type="text">enq_orig_lib</select>
        <select type="text">marcapt</select>

        <from>
            <subquery>
                <select type="number" alias="ID_MAREE">FT.ID</select>
                <select type="number" alias="ID_OBSERVATION">L.OBSERVED_LOCATION_FK</select>

                <select type="text" alias="ANNEE">to_char(L.LANDING_DATE_TIME, 'YYYY')</select>
                <select type="text" alias="TRIMESTRE">to_char(L.LANDING_DATE_TIME, 'Q')</select>
                <select type="text" alias="MOIS">to_char(L.LANDING_DATE_TIME, 'MM')</select>

                <select type="number" alias="PROGRAMME">FT.PROGRAM_FK</select>
                <select type="text" alias="NAVIRE">FT.VESSEL_FK</select>

                <select type="text" alias="IMMATRICULATION">vrp.REGISTRATION_CODE</select>
                <select type="text" alias="TYPE_NAVIRE">vessel_type_qv.NAME</select>
                <select type="date" alias="DATE_DEPART">FT.DEPARTURE_DATE_TIME</select>
                <select type="date" alias="DATE_RETOUR">FT.RETURN_DATE_TIME</select>
                <select type="date" alias="DATE_DEBARQ">L.LANDING_DATE_TIME</select>

                <select type="number" alias="PORTDEP_TYP">LOCDEP.LOCATION_LEVEL_FK</select>
                <select type="text" alias="PORTDEP_COD">LOCDEP.LABEL</select>
                <select type="text" alias="PORTDEP_LIB">LOCDEP.NAME</select>

                <select type="number" alias="PORTRET_TYP">LOCRET.LOCATION_LEVEL_FK</select>
                <select type="text" alias="PORTRET_COD">LOCRET.LABEL</select>
                <select type="text" alias="PORTRET_LIB">LOCRET.NAME</select>

                <select type="number" alias="PORTDEB_TYP">LOCDEB.LOCATION_LEVEL_FK</select>
                <select type="text" alias="PORTDEB_COD">LOCDEB.LABEL</select>
                <select type="text" alias="PORTDEB_LIB">LOCDEB.name</select>

                <select type="text" alias="QUARTIER_COD">LOCQ.LABEL</select>
                <select type="text" alias="QUARTIER_LIB">LOCQ.NAME</select>

                <select type="text" alias="ATELIER_COD">LOCR.LABEL</select>
                <select type="text" alias="ATELIER_LIB">LOCR.NAME</select>

                <select type="text" alias="DUREE_MAREE_JOUR">round((FT.RETURN_DATE_TIME - FT.DEPARTURE_DATE_TIME), 3)
                </select>

                <select type="text" alias="DUREE_MAREE_HEURE">round((FT.RETURN_DATE_TIME - FT.DEPARTURE_DATE_TIME) *
                    24,3)
                </select>
                <select type="text" alias="NB_HOMME">
                    SELECT
                    VM_NBH.NUMERICAL_VALUE
                    FROM
                    vessel_use_measurement VM_NBH
                    WHERE
                    1 = 1
                    AND VM_NBH.VESSEL_USE_FEATURES_FK = VUF.ID
                    AND VM_NBH.PMFM_FK = 1 --"+context.PMFM_CREW_SIZE+"
                </select>
                <select type="text" alias="TIME_FISHING">
                    CASE
                    WHEN FT.PROGRAM_FK IN ('ARTFISH', 'SCHOONER', 'WHALER')
                    /* ("+context.p03_obsdeb_sfa_programs+")*/
                    THEN round(
                    (FT.RETURN_DATE_TIME - FT.DEPARTURE_DATE_TIME) * 24,
                    3
                    )
                    ELSE (
                    /* LP 2021-09-21: consider default value 23.9997215 (1 day in obsdeb) as null */
                    SELECT
                    CASE
                    WHEN VM_TIME.NUMERICAL_VALUE = 23.9997215 THEN NULL
                    ELSE VM_TIME.NUMERICAL_VALUE
                    END
                    FROM
                    VESSEL_USE_MEASUREMENT VM_TIME
                    WHERE
                    1 = 1
                    AND VM_TIME.VESSEL_USE_FEATURES_FK = VUF2.ID
                    AND VM_TIME.PMFM_FK = 6 --"+context.PMFM_DURATION_AT_SEA+"
                    )
                    END
                </select>
                <select type="text" alias="NB_GEAR">
                    COALESCE(
                    /* LP 2021-09-21: from GEAR_PHYSICAL_MEASUREMENT */
                    (
                    SELECT
                    VM_NB_GEAR.NUMERICAL_VALUE
                    FROM
                    GEAR_PHYSICAL_MEASUREMENT VM_NB_GEAR
                    WHERE
                    1 = 1
                    AND VM_NB_GEAR.GEAR_PHYSICAL_FEATURES_FK = GPF.ID
                    AND VM_NB_GEAR.PMFM_FK = 253 --"+context.PMFM_GEAR_DIMENSION+"
                    ),
                    /* LP 2021-09-21: or from GEAR_USE_MEASUREMENT (historical data) */
                    (
                    SELECT
                    GUM_NB_GEAR.NUMERICAL_VALUE
                    FROM
                    GEAR_USE_MEASUREMENT GUM_NB_GEAR
                    WHERE
                    GUM_NB_GEAR.GEAR_USE_FEATURES_FK = GUF.ID
                    AND GUM_NB_GEAR.PMFM_FK = 253 --"+context.PMFM_GEAR_DIMENSION+"
                    )
                    )
                </select>
                <select type="number" alias="NB_HOOK">
                    SELECT
                    VM_NB_HOOK.NUMERICAL_VALUE
                    FROM
                    GEAR_PHYSICAL_MEASUREMENT VM_NB_HOOK
                    WHERE
                    1 = 1
                    AND VM_NB_HOOK.GEAR_PHYSICAL_FEATURES_FK = GPF.ID
                    AND VM_NB_HOOK.PMFM_FK = 66 -- or 84 in v4.2 --"+context.PMFM_GEAR_MESH_SIZE+"
                </select>
                <select type="text" alias="DOC_DECL">
                    SELECT
                    QV.NAME
                    FROM
                    vessel_use_measurement VM_DOCDECL,
                    QUALITATIVE_VALUE QV
                    WHERE
                    1 = 1
                    AND VM_DOCDECL.VESSEL_USE_FEATURES_FK = VUF.ID
                    AND VM_DOCDECL.PMFM_FK = 0 --"+context.PMFM_DECLARATIVE_DOCUMENT+"
                    AND QV.ID = VM_DOCDECL.QUALITATIVE_VALUE_FK
                </select>
                <select type="text" alias="ETAT_MER">
                    SELECT
                    QV.NAME || '-' || QV.DESCRIPTION
                    FROM
                    vessel_use_measurement VM_MER,
                    QUALITATIVE_VALUE QV
                    WHERE
                    1 = 1
                    AND VM_MER.VESSEL_USE_FEATURES_FK = VUF.ID
                    AND VM_MER.PMFM_FK = 0 --"+context.PMFM_SEA_STATE+"
                    AND QV.ID = VM_MER.QUALITATIVE_VALUE_FK
                </select>

                <select type="text" alias="METIER_COD_M">M.LABEL</select>
                <select type="text" alias="METIER_LIB_M">M.NAME</select>
                <select type="text" alias="ENGIN_COD_M">M.ENGIN_COD_M</select>
                <select type="text" alias="ESP_CIBLE_COD_M">MTG.LABEL</select>

                <select type="text" alias="SECTEUR_COD_M">LOCFA.LABEL</select>
                <select type="text" alias="SECTEUR_LIB_M">LOCFA.LABEL</select>
                <select type="number" alias="GRAD_DIST_ID_M">DTCG.ID</select>
                <select type="text" alias="GRAD_DIST_LIB_M">DTCG.NAME</select>
                <select type="number" alias="GRAD_DIST_ORD_M">DTCG.RANK_ORDER</select>
                <select type="text" alias="GRAD_PROF_LIB_M">DG.NAME</select>
                <select type="number" alias="GRAD_PROF_ORD_M">DG.RANK_ORDER</select>
                <select type="number" alias="GRAD_PROX_ID_M">NSA.ID</select>
                <select type="text" alias="GRAD_PROX_LIB_M">NSA.NAME</select>
                <select type="text" alias="GRAD_PROX_DESC_M">NSA.DESCRIPTION</select>
                <select type="text" alias="COMMENTAIRES">FT.COMMENTS</select>
                <select type="text" alias="SAISISSEUR_COD">P.EMPLOYEE_NUMBER</select>
                <select type="text" alias="SAISISSEUR_LIB">P.LASTNAME || ' ' || P.FIRSTNAME</select>
                <select type="date" alias="DATE_SAISIE">FT.CREATION_DATE</select>
                <select type="text" alias="ENQ_QUALIF_LIB">SELECT
                    QV.NAME
                    FROM
                    SURVEY_MEASUREMENT SM,
                    QUALITATIVE_VALUE QV
                    WHERE
                    QV.ID = SM.QUALITATIVE_VALUE_FK
                    AND SM.FISHING_TRIP_FK = FT.ID
                    AND SM.PMFM_FK = 0 --"+context.PMFM_SURVEY_QUALIFICATION+"
                </select>
                <select type="text" alias="ENQ_ORIG_COD">CASE
                    FT.PROGRAM_FK
                    WHEN 'SIH-OBSDEB'
                    /*'"+context.PROGRAM_OBSDEB+"'*/
                    THEN 'O'
                    WHEN 'SIH-TELDEB'
                    /*'"+context.PROGRAM_TELDEB+"'*/
                    THEN 'T'
                    WHEN 'SIH-OPRDEB'
                    /*'"+context.PROGRAM_OPRDEB+"'*/
                    THEN 'E'
                    ELSE 'Z'
                    END
                </select>
                <select type="text" alias="ENQ_ORIG_LIB">CASE
                    FT.PROGRAM_FK
                    WHEN 'SIH-OBSDEB'
                    /*'"+context.PROGRAM_OBSDEB+"'*/
                    THEN 'Observation'
                    WHEN 'SIH-TELDEB'
                    /*'"+context.PROGRAM_TELDEB+"'*/
                    THEN 'Enquête téléphonique'
                    WHEN 'SIH-OPRDEB'
                    /*'"+context.PROGRAM_OPRDEB+"'*/
                    THEN 'Enquête de terrain'
                    ELSE 'Ancien programme SFA'
                    END
                </select>
                <select type="text" alias="MARCAPT">ENQ_ORIG_LIB</select>

                <from alias="FT">FISHING_TRIP</from>
                <from join="true">INNER JOIN LANDING L ON L.FISHING_TRIP_FK = FT.ID
                </from>
                <from join="true">INNER JOIN LOCATION LOCDEP ON LOCDEP.ID = FT.DEPARTURE_LOCATION_FK
                </from>
                <from join="true">INNER JOIN LOCATION LOCRET ON LOCRET.ID = FT.RETURN_LOCATION_FK
                </from>
                <from join="true">INNER JOIN LOCATION LOCDEB ON LOCDEB.ID = L.LANDING_LOCATION_FK
                </from>
                <from join="true">INNER JOIN LOCATION_HIERARCHY LOCHQ ON LOCHQ.CHILD_LOCATION_FK = L.LANDING_LOCATION_FK
                </from>
                <from join="true">INNER JOIN LOCATION LOCQ ON LOCQ.ID = LOCHQ.PARENT_LOCATION_FK
                </from>
                <from join="true">INNER JOIN LOCATION_HIERARCHY LOCHR ON LOCHR.CHILD_LOCATION_FK = L.LANDING_LOCATION_FK
                </from>
                <from join="true">INNER JOIN LOCATION LOCR ON LOCR.ID = LOCHR.PARENT_LOCATION_FK
                </from>
                <from join="true">INNER JOIN OPERATION O ON O.FISHING_TRIP_FK = FT.ID</from>
                <from join="true">LEFT OUTER JOIN OPERATION O2 ON O2.FISHING_TRIP_FK = FT.ID AND O2.IS_MAIN_OPERATION =
                    0
                </from>
                <from join="true">LEFT OUTER JOIN GEAR_USE_FEATURES GUF ON GUF.OPERATION_FK = O.ID
                </from>
                <from join="true">LEFT OUTER JOIN GEAR_USE_FEATURES GUF2 ON GUF2.OPERATION_FK = O2.ID
                </from>
                <from join="true">LEFT OUTER JOIN FISHING_AREA FA ON FA.GEAR_USE_FEATURES_FK = GUF.ID
                </from>
                <from join="true">LEFT OUTER JOIN LOCATION LOCFA ON LOCFA.ID = FA.LOCATION_FK
                </from>
                <from join="true">LEFT OUTER JOIN DISTANCE_TO_COAST_GRADIENT DTCG ON DTCG.ID =
                    FA.DISTANCE_TO_COAST_GRADIENT_FK
                </from>
                <from join="true">LEFT OUTER JOIN DEPTH_GRADIENT DG ON DG.ID = FA.DEPTH_GRADIENT_FK
                </from>
                <from join="true">LEFT OUTER JOIN NEARBY_SPECIFIC_AREA NSA ON NSA.ID = FA.NEARBY_SPECIFIC_AREA_FK
                </from>
                <from join="true">LEFT OUTER JOIN VESSEL_USE_FEATURES VUF ON VUF.FISHING_TRIP_FK = FT.ID
                </from>
                <from join="true">LEFT OUTER JOIN VESSEL_USE_FEATURES VUF2 ON VUF2.OPERATION_FK = O2.ID
                </from>
                <from join="true">LEFT OUTER JOIN METIER M ON M.ID = GUF2.METIER_FK OR M.ID = GUF.METIER_FK</from>
                <from join="true">LEFT OUTER JOIN GEAR MG ON M.GEAR_FK = MG.ID
                </from>
                <from join="true">LEFT OUTER JOIN TAXON_GROUP MTG ON M.TAXON_GROUP_FK = MTG.ID
                </from>
                <from join="true">LEFT OUTER JOIN GEAR_PHYSICAL_FEATURES GPF ON GPF.FISHING_TRIP_FK = FT.ID
                    AND GPF.GEAR_FK = MG.ID
                    AND (
                    GPF.METIER_FK IS NULL
                    OR GPF.METIER_FK = M.ID
                    )
                </from>
                <from join="true">LEFT OUTER JOIN PERSON P ON P.ID = FT.RECORDER_PERSON_FK
                </from>
                <from join="true">LEFT OUTER JOIN VESSEL_REGISTRATION_PERIOD vrp ON vrp.VESSEL_FK = FT.VESSEL_FK
                    AND vrp.END_DATE_TIME IS NULL
                </from>
                <from join="true">LEFT OUTER JOIN VESSEL_USE_MEASUREMENT vum ON vum.VESSEL_USE_FEATURES_FK = vuf.id
                    AND vum.PMFM_FK = 230
                </from>
                <from join="true">LEFT OUTER JOIN QUALITATIVE_VALUE vessel_type_qv ON vum.QUALITATIVE_VALUE_FK =
                    vessel_type_qv.ID
                </from>

                <where>1=1</where>
                <where operator="AND">LOCQ.LOCATION_LEVEL_FK = 32 --"+context.LOCATION_LEVEL_QUARTER+"</where>
                <where operator="AND">LOCR.LOCATION_LEVEL_FK = 31 --"+context.LOCATION_LEVEL_REGION+"</where>
                <where operator="AND">L.PROGRAM_FK IN (
                    'SIH-OBSDEB',
                    'SIH-TELDEB',
                    'SIH-OPRDEB',
                    'ARTFISH',
                    'SCHOONER',
                    'WHALER'
                    )
                </where>
                <where operator="AND">EXTRACT(
                    YEAR
                    FROM
                    L.LANDING_DATE_TIME
                    ) IN (2022)
                </where>
            </subquery>
            <where operator="AND">LOCQ.LOCATION_LEVEL_FK = 32 --"+context.LOCATION_LEVEL_QUARTER+"</where>
            <groupby>
                ID_MAREE,
                id_observation,
                annee,
                trimestre,
                mois,
                programme,
                navire,
                immatriculation,
                type_navire,
                date_depart,
                date_retour,
                date_debarq,
                portdep_typ,
                portdep_cod,
                portdep_lib,
                portret_typ,
                portret_cod,
                portret_lib,
                portdeb_typ,
                portdeb_cod,
                portdeb_lib,
                quartier_cod,
                quartier_lib,
                atelier_cod,
                atelier_lib,
                duree_maree_jour,
                duree_maree_heure,
                NB_HOMME,
                DOC_DECL,
                ETAT_MER,
                metier_cod_m,
                metier_lib_m,
                engin_cod_m,
                esp_cible_cod_m,
                secteur_cod_m,
                secteur_lib_m,
                grad_dist_id_m,
                grad_dist_lib_m,
                grad_dist_ord_m,
                grad_prof_id_m,
                grad_prof_lib_m,
                grad_prof_ord_m,
                grad_prox_id_m,
                grad_prox_lib_m,
                grad_prox_desc_m,
                commentaires,
                saisisseur_cod,
                saisisseur_lib,
                date_saisie,
                ENQ_QUALIF_LIB,
                enq_orig_cod,
                enq_orig_lib,
                marcapt
            </groupby>
            <orderby direction="desc">DATE_DEBARQ</orderby>
        </from>
    </query>
</queries>