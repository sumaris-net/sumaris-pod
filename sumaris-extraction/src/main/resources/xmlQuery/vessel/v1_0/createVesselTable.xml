<?xml version="1.0" encoding="UTF-8"?>
<!--
  ~ #%L
  ~ SUMARiS
  ~ %%
  ~ Copyright (C) 2019 SUMARiS Consortium
  ~ %%
  ~ This program is free software: you can redistribute it and/or modify
  ~ it under the terms of the GNU General Public License as
  ~ published by the Free Software Foundation, either version 3 of the
  ~ License, or (at your option) any later version.
  ~
  ~ This program is distributed in the hope that it will be useful,
  ~ but WITHOUT ANY WARRANTY; without even the implied warranty of
  ~ MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  ~ GNU General Public License for more details.
  ~
  ~ You should have received a copy of the GNU General Public
  ~ License along with this program.  If not, see
  ~ <http://www.gnu.org/licenses/gpl-3.0.html>.
  ~ #L%
  -->

<queries name="extractionCreateStrategyTable">

  <query type="create" temp="false" table="&amp;vesselTableName" option="DISTINCT">

    <!-- PK -->
    <select alias="RECORD_TYPE" type="text" group="recordType">UPPER('VE')</select>
    <select alias="PROJECT" type="text">P.LABEL</select>
    <select alias="VESSEL_IDENTIFIER" type="number">V.ID</select>
    <select alias="VESSEL_FLAG_COUNTRY" type="text">COUNTRY.LABEL</select>
    <select alias="REGISTRATION_START_DATE" type="text">TO_CHAR(VRP.START_DATE, 'DD/MM/YYYY')</select>
    <select alias="REGISTRATION_END_DATE" type="text">TO_CHAR(VRP.END_DATE, 'DD/MM/YYYY')</select>
    <select alias="INTERNATIONAL_REGISTRATION_CODE" type="text">VRP.INT_REGISTRATION_CODE</select>
    <select alias="REGISTRATION_CODE" type="text">VRP.REGISTRATION_CODE</select>
    <select alias="HARBOUR_LABEL" type="text">HARBOUR.LABEL</select>
    <select alias="HARBOUR_NAME" type="text">HARBOUR.NAME</select>
    <select alias="FEATURES_START_DATE" type="text">TO_CHAR(VF.START_DATE, 'DD/MM/YYYY') </select>
    <select alias="FEATURES_END_DATE" type="text">TO_CHAR(VF.END_DATE, 'DD/MM/YYYY') </select>
    <select alias="NAME" type="text">VF.NAME</select>
    <select alias="LENGTH_OVER_ALL" type="number">CAST(VF.LENGTH_OVER_ALL AS FLOAT) / 100</select>
    <select alias="ADMINISTRATIVE_POWER_KW" type="number">VF.ADMINISTRATIVE_POWER</select>
    <select alias="GROSS_TONNAGE_UMS" type="number">CAST(VF.GROSS_TONNAGE_GT AS FLOAT) / 100</select>
    <select alias="CONSTRUCTION_YEAR" type="number">VF.CONSTRUCTION_YEAR</select>
    <select alias="IRCS" type="text">VF.IRCS</select>
    <select alias="AUXILIARY_POWER" type="number">VF.AUXILIARY_POWER</select>
    <select alias="HULL_MATERIAL" type="text">QV_HULL.NAME</select>

    <select alias="PROJECTS" dbms="hsqldb,pgsql" type="text" group="agg">ARRAY_AGG(P.LABEL)</select>
    <select alias="PROJECTS" dbms="oracle" type="text" group="agg,oracle11">LISTAGG(P.LABEL, ',')</select>
    <select alias="PROJECTS" dbms="oracle" type="text" group="agg,oracle12">LISTAGG(P.LABEL, ',') WITHIN GROUP (ORDER BY P.LABEL)</select>

    <!-- hidden columns -->

    <from alias="V">VESSEL</from>
    <from join="true">LEFT OUTER JOIN VESSEL_REGISTRATION_PERIOD VRP ON VRP.VESSEL_FK=V.ID</from>
    <from join="true">LEFT OUTER JOIN LOCATION COUNTRY ON VRP.REGISTRATION_LOCATION_FK = COUNTRY.ID</from>
    <from join="true">LEFT OUTER JOIN VESSEL_FEATURES VF ON VF.VESSEL_FK=V.ID</from>
    <from join="true">LEFT OUTER JOIN LOCATION HARBOUR ON VF.BASE_PORT_LOCATION_FK = HARBOUR.ID</from>
    <from join="true">LEFT OUTER JOIN QUALITATIVE_VALUE QV_HULL ON QV_HULL.ID = VF.HULL_MATERIAL_QV_FK</from>
    <from join="true">LEFT OUTER JOIN TRIP T ON T.VESSEL_FK = V.ID</from>
    <from join="true">LEFT OUTER JOIN PROGRAM P ON T.PROGRAM_FK = P.ID</from>

    <where>1=1</where>
    <where operator="AND" group="programLabelsFilter">
      <in field="P.LABEL"><![CDATA[&programLabels]]></in>
    </where>

    <where operator="AND" group="idsFilter">
      <in field="V.ID"><![CDATA[&ids]]></in>
    </where>

    <where operator="AND" group="statusIdsFilter">
      <in field="V.STATUS_FK"><![CDATA[&statusIds]]></in>
    </where>

    <where operator="AND" group="startDateFilter"><![CDATA[VRP.END_DATE >= &startDate]]></where>
    <where operator="AND" group="endDateFilter"><![CDATA[VRP.START_DATE <= &endDate]]></where>

    <where operator="AND" group="registrationLocationIdsFilter">
      <in field="COUNTRY.ID"><![CDATA[&registrationLocationIds]]></in>
    </where>
    <where operator="AND" group="basePortLocationIdsFilter">
      <in field="HARBOUR.ID"><![CDATA[&basePortLocationIds]]></in>
    </where>
    <groupby>&amp;groupByColumns</groupby>
    <orderby>V.ID</orderby>

  </query>

</queries>
