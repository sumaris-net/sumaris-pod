# ---------------------------------------------------------------
# Global
# ---------------------------------------------------------------

# default image
image: jlrigau/maven-git

# stages (main steps of pipeline)
stages:
    - build
    - alt_build
    - test
    - deploy
    - release
    - docs

# ---------------------------------------------------------------
# Global variables
# ---------------------------------------------------------------

variables:
    DOCKER_DRIVER: overlay2
    ANSIBLE_FORCE_COLOR: '1'
    CONTAINER_BUILD_IMAGE: $CI_REGISTRY_IMAGE:build
    CONTAINER_TEST_IMAGE: $CI_REGISTRY_IMAGE:$CI_COMMIT_REF_SLUG
    CONTAINER_RELEASE_IMAGE: $CI_REGISTRY_IMAGE:latest
    MAVEN_REPO_URL: https://gitlab.ifremer.fr/api/v4/projects/1272/packages/maven
    APP_CORE_MODULE: sumaris-core
    APP_DB_MODULE: sumaris-db
    APP_WAR_MODULE: sumaris-server

# ---------------------------------------------------------------
# Jobs templates
# ---------------------------------------------------------------

.build:
    stage: build
    tags: [sih_public_runner]
    script:
        - echo "Test dev build in progress"
        - mvn -s ./ci_settings.xml -q clean install -DskipTests
    environment:
        name: test
    artifacts:
        paths:
            - sumaris-server/target/*.war
        expire_in: 60 minutes

.docker:
    image: docker:latest
    tags: [sih_public_runner]
    services:
        - docker:dind
    before_script:
        - docker login -u gitlab-ci-token -p ${CI_BUILD_TOKEN} ${CI_REGISTRY} || true
    after_script:
        - docker logout ${CI_REGISTRY}
    allow_failure: false

.deploy-file:
    stage: deploy
    tags: [sih_public_runner]
    script:
        - APP_VERSION=$(mvn org.apache.maven.plugins:maven-help-plugin:3.2.0:evaluate -Dexpression=project.version -q -DforceStdout)
        - APP_GROUP_ID=$(mvn org.apache.maven.plugins:maven-help-plugin:3.2.0:evaluate -Dexpression=project.groupId -q -DforceStdout)
        - mvn -s ./ci_settings.xml deploy:deploy-file -DgroupId=${APP_GROUP_ID} -DartifactId=${APP_WAR_MODULE} -Dversion=${APP_VERSION} -Dfile=${APP_WAR_MODULE}/target/${APP_WAR_MODULE}-${APP_VERSION}.war -DrepositoryId=job-maven -Durl=$MAVEN_REPO_URL

# ---------------------------------------------------------------
# Build jobs
# ---------------------------------------------------------------

fast-build:
    extends: .build
    image: ${CONTAINER_BUILD_IMAGE}
    only:
        - develop

failsafe-build:
    extends: .build
    stage: alt_build
    when: on_failure
    only:
        - develop

docker-for-fast-build:
    extends: .docker
    stage: alt_build
    when: on_failure
    allow_failure: true
    before_script:
        - echo 'FROM jlrigau/maven-git' > Dockerfile
        - echo 'WORKDIR /customCache' >> Dockerfile
        - echo 'COPY ./ ./' >> Dockerfile
        - echo 'RUN du -s `find . -maxdepth 1 | egrep -v "^\.$"`>/before.txt' >> Dockerfile
        - echo 'RUN mvn -s ./ci_settings.xml -q -U dependency:purge-local-repository' >> Dockerfile
        - echo 'RUN du -s `find . -maxdepth 1 | egrep -v "^\.$"`>/after.txt' >> Dockerfile
        - echo 'WORKDIR /build' >> Dockerfile
        - echo "RUN diff /before.txt /after.txt || true" >> Dockerfile
    script:
        - docker build --pull -t ${CI_REGISTRY_IMAGE} .
        - docker push ${CI_REGISTRY_IMAGE}

# ---------------------------------------------------------------
# Test jobs
# ---------------------------------------------------------------

sonarqube:
    stage: test
    tags:
        - sih_public_runner
    variables:
        SONAR_TOKEN: "e6f816eee72d3d5c03319ec74b468157b9164d12"
        SONAR_HOST_URL: http://visi-common-sonar.ifremer.fr:9000
    image:
        name: sonarsource/sonar-scanner-cli:latest
        entrypoint: [""]
    script:
        - echo "Sonarqube analysis in progress"
        - sonar-scanner
            -Dsonar.projectKey=imagine-pod
            -Dsonar.host.url=$SONAR_HOST_URL
            -Dsonar.login=$SONAR_TOKEN
            -Dsonar.sourceEncoding=UTF-8
            -Dsonar.java.binaries=.
            -Dsonar.java.libraries=.
    only:
        - develop
        - feature/imagine
    when: manual


# ---------------------------------------------------------------
# Deploy jobs
# ---------------------------------------------------------------

fast-deploy-file:
    extends: .deploy-file
    needs:
        - fast-build
    only:
        - develop

failsafe-deploy-file:
    extends: .deploy-file
    needs:
        - failsafe-build
    only:
        - develop

# ---------------------------------------------------------------
# Release jobs
# ---------------------------------------------------------------


release:
    stage: release
    tags: [ sih_public_runner ]
    before_script:
        - git checkout -B "$CI_BUILD_REF_NAME"
        - git config --global user.email "${GITLAB_USER_EMAIL}"
        - git config --global user.name "${GITLAB_USER_NAME}"
        - echo "RELEASE_VERSION=${RELEASE_VERSION}" >> variables.env
    script:
        - echo "Preparing release..."
        - git branch -D release/$RELEASE_VERSION || true
        - mvn -s ./ci_settings.xml -B gitflow:release-start --batch-mode -DreleaseVersion="$RELEASE_VERSION"
        - echo "Performing release..."
#        - mvn -s ./ci_settings.xml clean deploy --batch-mode -DperformRelease -DskipTests -Drelease.server=job-maven -Phsqldb,gitlab-profile
        - mvn -s ./ci_settings.xml clean deploy --batch-mode -DperformRelease -DskipTests -Phsqldb,gitlab-profile
        - echo "Creating test DB..."
        - mvn -pl ${APP_CORE_MODULE} -q -Prun,hsqldb -DskipTests --batch-mode
        - cd ${APP_CORE_MODULE}/target && tar -cf "${APP_DB_MODULE}-${RELEASE_VERSION}.tar.gz" db && cd ../..
        - echo "Pushing changes to upstream"
        - git commit -a -m "Release $RELEASE_VERSION"
        - git status
        - mvn gitflow:release-finish
    artifacts:
        paths:
            - sumaris-core/target/*.tar.gz
            - sumaris-server/target/*.war
            - sumaris-server/target/*.zip
        reports:
            dotenv: variables.env
    only:
        - develop
    when: manual

gitlab-release:
    stage: release
    tags: [ sih_public_runner ]
    image: registry.gitlab.com/gitlab-org/release-cli:latest
    script:
        - echo "running release for ${CI_COMMIT_TAG}"
    release:
        name: "Release sumaris-pod-$TAG"
        description: "Created using the release-cli $EXTRA_DESCRIPTION"
        tag_name: "${CI_COMMIT_TAG}"
        ref: "${CI_COMMIT_TAG}"
    only:
        - tags

# ---------------------------------------------------------------
# Docs jobs
# ---------------------------------------------------------------

pages:
    stage: docs
    tags:
        - sih_public_runner
    image: python:3.7-alpine
    before_script:
        - git submodule foreach git fetch origin
        - git submodule foreach git pull
    script:
        - Echo "Generate SVG images"
        - git submodule foreach ./generate.sh
        - mvn -s ./ci_settings.xml site -q -Prun,hsqldb -DperformRelease
    after_script:
        - mv target/site public
    artifacts:
        paths:
            - public
    only:
        - develop
        - feature/imagine
    when: manual


