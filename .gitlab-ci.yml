# ---------------------------------------------------------------
# Global
# ---------------------------------------------------------------

# default image
image: maven:3.8.5-eclipse-temurin-17-alpine

# stages (main steps of pipeline)
stages:
    - build
    - alt_build
    - test
    - release
    - docker
    - publish
    - docs

# ---------------------------------------------------------------
# Global variables
# ---------------------------------------------------------------

variables:
    DOCKER_IMAGE: maven:3.8.5-eclipse-temurin-17-alpine
    DOCKER_IMAGE_REGISTRY:
    #DOCKER_IMAGE_REGISTRY: gitlab-registry.ifremer.fr/ifremer-commons/docker/images/
    CI_BUILD_IMAGE: $CI_REGISTRY_IMAGE/build:develop
    #CONTAINER_SNAPSHOT_IMAGE: $CI_REGISTRY_IMAGE:$CI_COMMIT_REF_SLUG
    CONTAINER_SNAPSHOT_IMAGE: $CI_REGISTRY_IMAGE:develop
    MAVEN_LOCAL_REPO: /root/.m2/repository/
    MAVEN_REPO_URL: https://gitlab.ifremer.fr/api/v4/projects/1272/packages/maven
    APP_SHARED_MODULE: sumaris-core-shared
    APP_CORE_MODULE: sumaris-core
    APP_DB_MODULE: sumaris-db
    APP_WAR_MODULE: sumaris-server
    ARTIFACT_WAR_FILE: "${APP_WAR_MODULE}/target/*.war"
    ARTIFACT_CONFIG_FILES: "${APP_WAR_MODULE}/target/classes/*.properties"
    ENV_FILE: target/variables.env

# ---------------------------------------------------------------
# Jobs templates
# ---------------------------------------------------------------
.configure-git-template: &git-setup
  before_script:
    - echo "fetch origin using token --${CI_ACCESS_TOKEN}--"
    - git remote set-url origin "https://gitlab+access-token:${CI_ACCESS_TOKEN}@gitlab.ifremer.fr/${CI_PROJECT_PATH}.git"
    - git config --global user.email "${GITLAB_USER_EMAIL}"
    - git config --global user.name "${GITLAB_USER_NAME}"
    - git fetch origin
  tags: [sih_public_runner]

.docker:
    image: docker:latest
    tags: [sih_public_runner]
    services:
        - docker:dind
    before_script:
        - docker login -u ${CI_REGISTRY_USER} -p ${CI_REGISTRY_PASSWORD} ${CI_REGISTRY}
    after_script:
        - docker logout ${CI_REGISTRY}
    allow_failure: false

# ---------------------------------------------------------------
# Build jobs
# ---------------------------------------------------------------
.build:
    stage: build
    tags: [sih_public_runner]
    script:
        - echo "Building from sources..."
        - mvn clean package -DskipTests
    after_script:
        # Get project version
        - mkdir -p target
        - APP_VERSION=$(mvn org.apache.maven.plugins:maven-help-plugin:3.2.0:evaluate -Dexpression=project.version -q -DforceStdout --non-recursive)
        - echo "APP_VERSION=${APP_VERSION}" > ${ENV_FILE}
    artifacts:
        paths:
            - ${ARTIFACT_WAR_FILE}
            - ${ARTIFACT_CONFIG_FILES}
        reports:
            dotenv: ${ENV_FILE}
        expire_in: 12 hours
    environment:
        name: test

build:
    extends: .build
    image: ${CI_BUILD_IMAGE}
    only:
      - develop

build:feature:
  extends: .build
  image: ${CI_BUILD_IMAGE}
  only:
    - /^feature\/.*/
    - /^features\/.*/
  when: manual

failsafe-build:
    extends: .build
    stage: alt_build
    when: on_failure
    only:
      - develop
      - /^feature\/.*/
      - /^features\/.*/

# ---------------------------------------------------------------
# Environment jobs : Create docker image for builds/release, this
# offers possibility to cache project dependencies so we don't
# have to download them every time.
# ---------------------------------------------------------------
build:env:
    extends: .docker
    stage: alt_build
    when: on_failure
    allow_failure: true
    script:
      # Create the target directory
      - mkdir -p target/docker
      - cp -rf ${APP_WAR_MODULE}/src/main/docker/build/* target/docker
      # Build and push the CI image
      - docker build --cache-from ${CI_BUILD_IMAGE} --pull -t ${CI_BUILD_IMAGE} --build-arg="IMAGE_REGISTRY=${DOCKER_IMAGE_REGISTRY}" -f target/docker/Dockerfile .
      - docker push ${CI_BUILD_IMAGE}
    only:
      - develop
      - /^feature\/.*/
      - /^features\/.*/

# ---------------------------------------------------------------
# Tests jobs
# ---------------------------------------------------------------
.test:
    stage: test
    tags: [sih_public_runner]
    script:
        - mvn verify surefire-report:report -s ./ci_settings.xml -q
    environment:
        name: test
    artifacts:
        paths:
          - ${APP_SHARED_MODULE}/site/surefire-report.html
          - ${APP_SHARED_MODULE}/target/surefire-reports/*
          - ${APP_CORE_MODULE}/site/surefire-report.html
          - ${APP_CORE_MODULE}/target/surefire-reports/*
          - ${APP_WAR_MODULE}/target/surefire-reports/*
          - ${APP_WAR_MODULE}/site/surefire-report.html
        expire_in: 72 hours

test:
    extends: .test
    image: ${CI_BUILD_IMAGE}
    rules:
      - if: $CI_COMMIT_TAG
        when: never
      - if: '$CI_MERGE_REQUEST_ID || $CI_COMMIT_BRANCH == "develop" || $CI_COMMIT_BRANCH =~ /^feature/ || $CI_COMMIT_BRANCH =~ /^features/'
        when: manual
    allow_failure: true

sonarqube:
    stage: test
    tags: [sih_public_runner]
    variables:
        SONAR_TOKEN: "e6f816eee72d3d5c03319ec74b468157b9164d12"
        SONAR_HOST_URL: http://visi-common-sonar.ifremer.fr:9000
    image:
        name: sonarsource/sonar-scanner-cli:latest
        entrypoint: [""]
    script:
        - echo "Sonarqube analysis in progress"
        - sonar-scanner
            -Dsonar.projectKey=imagine-pod
            -Dsonar.host.url=$SONAR_HOST_URL
            -Dsonar.login=$SONAR_TOKEN
            -Dsonar.sourceEncoding=UTF-8
            -Dsonar.java.binaries=.
            -Dsonar.java.libraries=.
    allow_failure: true
    only:
      - develop
      - /^feature\/.*/
      - /^features\/.*/
    when: manual

# ---------------------------------------------------------------
# Release jobs
# ---------------------------------------------------------------

.release:
  <<: *git-setup
  stage: release
  tags: [sih_public_runner]
  script:
    - echo "Preparing release..."
    - export MVN_OPTS="-DinstallProject=false -DpushRemote=false"
    - if [[ "_${RELEASE_VERSION}" == "_" ]]; then echo "Missing pipeline variable 'RELEASE_VERSION' !" && exit 1; fi
    - MVN_OPTS="${MVN_OPTS} -DreleaseVersion=${RELEASE_VERSION}"
    - mvn --batch-mode gitflow:release-start ${MVN_OPTS}
    - echo "Performing release..."
    - mvn clean package --batch-mode -DskipTests -DperformRelease -Phsqldb -Denv=hsqldb
    - echo "Deploy binaries to package registry"
    - APP_VERSION=$(mvn org.apache.maven.plugins:maven-help-plugin:3.2.0:evaluate -Dexpression=project.version -q -DforceStdout --non-recursive)
    - APP_GROUP_ID=$(mvn org.apache.maven.plugins:maven-help-plugin:3.2.0:evaluate -Dexpression=project.groupId -q -DforceStdout --non-recursive)
    - mvn deploy:deploy-file -s ./ci_settings.xml -DgroupId=${APP_GROUP_ID} -DartifactId=${APP_WAR_MODULE} -Dversion=${APP_VERSION} -Dfile=${APP_WAR_MODULE}/target/${APP_WAR_MODULE}-${APP_VERSION}.war -DrepositoryId=job-maven -Durl=$MAVEN_REPO_URL
    - mvn deploy:deploy-file -s ./ci_settings.xml -DgroupId=${APP_GROUP_ID} -DartifactId=${APP_WAR_MODULE} -Dversion=${APP_VERSION} -Dfile=${APP_WAR_MODULE}/target/${APP_WAR_MODULE}-${APP_VERSION}-standalone.zip -Dpackaging=zip -DrepositoryId=job-maven -Durl=$MAVEN_REPO_URL
    - echo "Pushing changes to upstream"
    - git diff --cached
    - git commit -am "[CI] release performed" || echo "Nothing to commit, continue"
    - mvn -B gitflow:release-finish -DskipTestProject=true -DpushRemote=true
    - echo "-- Generated WAR files:"
    - ls -la ${ARTIFACT_WAR_FILE}
    - echo "-- Generated config files:"
    - ls -la  ${ARTIFACT_CONFIG_FILES}
    - echo "APP_VERSION=${APP_VERSION}" > ${ENV_FILE}
  artifacts:
    paths:
      - ${ARTIFACT_WAR_FILE}
      - ${ARTIFACT_CONFIG_FILES}
      # FIXME: BLA - comment out to avoid an error "Request Entity Too Large"
      #- ${APP_WAR_MODULE}/target/*.zip
    reports:
      dotenv: ${ENV_FILE}
    expire_in: 60 minutes
  allow_failure: false
  only:
    - develop
  when: manual

release:
  extends: .release
  image: ${CI_BUILD_IMAGE}
  needs: [build]

release:tags:
  <<: *git-setup
  image: ${CI_BUILD_IMAGE}
  stage: release
  tags: [sih_public_runner]
  script:
    - echo "Performing release..."
    - export MVN_OPTS="-DinstallProject=false -DpushRemote=false -DreleaseVersion=${CI_COMMIT_TAG}"
    - mvn clean package --batch-mode -DskipTests -DperformRelease -Phsqldb
    - echo "Deploy binaries to package registry"
    - APP_VERSION=$(mvn org.apache.maven.plugins:maven-help-plugin:3.2.0:evaluate -Dexpression=project.version -q -DforceStdout --non-recursive)
    - APP_GROUP_ID=$(mvn org.apache.maven.plugins:maven-help-plugin:3.2.0:evaluate -Dexpression=project.groupId -q -DforceStdout --non-recursive)
    - mvn deploy:deploy-file -s ./ci_settings.xml -DgroupId=${APP_GROUP_ID} -DartifactId=${APP_WAR_MODULE} -Dversion=${APP_VERSION} -Dfile=${APP_WAR_MODULE}/target/${APP_WAR_MODULE}-${APP_VERSION}.war -DrepositoryId=job-maven -Durl=$MAVEN_REPO_URL
    - mvn deploy:deploy-file -s ./ci_settings.xml -DgroupId=${APP_GROUP_ID} -DartifactId=${APP_WAR_MODULE} -Dversion=${APP_VERSION} -Dfile=${APP_WAR_MODULE}/target/${APP_WAR_MODULE}-${APP_VERSION}-standalone.zip -Dpackaging=zip -DrepositoryId=job-maven -Durl=$MAVEN_REPO_URL
  artifacts:
    paths:
      - ${ARTIFACT_WAR_FILE}
      - ${ARTIFACT_CONFIG_FILES}
      # FIXME: BLA - comment out to avoid an error "Request Entity Too Large"
      #- ${APP_WAR_MODULE}/target/*.zip
    expire_in: 60 minutes
  allow_failure: false
  only:
    - tags
  when: manual

failsafe-release:
    extends: .release
    needs: [failsafe-build]

gitlab-release:
    stage: release
    tags: [sih_public_runner]
    image: registry.gitlab.com/gitlab-org/release-cli:latest
    script:
        - echo "running release for ${CI_COMMIT_TAG}"
    release:
        name: "Release ${CI_PROJECT_NAME}-${CI_COMMIT_TAG}"
        description: "Created using the release-cli $EXTRA_DESCRIPTION"
        tag_name: "${CI_COMMIT_TAG}"
        ref: "${CI_COMMIT_TAG}"
    only:
        - tags

# ---------------------------------------------------------------
# Docker jobs
# ---------------------------------------------------------------
.docker-build:
    extends: .docker
    stage: docker
    script:
        # Build variables: set default values
        - export IMAGE_USERID=${IMAGE_USERID:-20001}
        - export IMAGE_GROUPID=${IMAGE_GROUPID:-20001}
        # Create the target directory, to build the image
        - mkdir -p target/docker/config
        - cp -rf ${APP_WAR_MODULE}/src/main/docker/run/* target/docker/
        - cp -f ${ARTIFACT_WAR_FILE} target/docker/app.war
        - cp -f ${ARTIFACT_CONFIG_FILES} target/docker/config/
        - ls -l target/docker/config
        - cd target/docker
        # Build docker image
        - docker pull ${CI_REGISTRY_IMAGE}:${IMAGE_TAG} || true
        - docker build --cache-from ${CI_REGISTRY_IMAGE}:${IMAGE_TAG} --pull -t ${CI_REGISTRY_IMAGE}:${IMAGE_TAG} --build-arg="IMAGE_REGISTRY=${DOCKER_IMAGE_REGISTRY}" --build-arg="USERID=${IMAGE_USERID}" --build-arg="GROUPID=${IMAGE_GROUPID}" .
        - docker push ${CI_REGISTRY_IMAGE}:${IMAGE_TAG}
    artifacts:
        paths:
            - target/docker
        expire_in: 12 hours

# to run specific feature
docker:feature:
  extends: .docker-build
  needs: ['build:feature']
  variables:
    IMAGE_TAG: 'feature'
  only:
    - /^feature\/.*/
    - /^features\/.*/

docker:develop:
    extends: .docker-build
    needs: [build]
    variables:
        IMAGE_TAG: 'develop'
        IMAGE_USERID: ${PRODUCTION_IMAGE_USERID}
        IMAGE_GROUPID: ${PRODUCTION_IMAGE_GROUPID}
    only:
        - develop

docker:release:
    extends: .docker-build
    needs: [release]
    variables:
        IMAGE_TAG: ${APP_VERSION}
        IMAGE_USERID: ${PRODUCTION_IMAGE_USERID}
        IMAGE_GROUPID: ${PRODUCTION_IMAGE_GROUPID}
    only:
        - develop

docker:release:tags:
  extends: .docker-build
  needs: [release:tags]
  variables:
    IMAGE_TAG: ${CI_COMMIT_TAG}
    IMAGE_USERID: ${PRODUCTION_IMAGE_USERID}
    IMAGE_GROUPID: ${PRODUCTION_IMAGE_GROUPID}
  only:
    - tags

# ---------------------------------------------------------------
# Docs jobs
# ---------------------------------------------------------------

.pages:
  stage: docs
  image: ${CI_BUILD_IMAGE}
  tags: [sih_public_runner]
  before_script:
      - git submodule foreach git fetch origin
      - git submodule foreach git pull
  script:
      - echo "---- Generating SVG, from '*.plantuml' files..."
      - git submodule foreach ./generate.sh || true
      - echo "---- Generating Maven site..."
      - mvn site -s ./ci_settings.xml -q -Phsqldb -DperformRelease
  after_script:
      - mv target/site public
  allow_failure: true
  artifacts:
      paths:
          - public

pages:develop:
  extends: .pages
  only:
      - develop
  when: manual

pages:release:
  extends: .pages
  only:
      - tags
  when: manual
