include:
  - project: Zenika/forge/ci-cd
    ref: main
    file: /pipelines/java.yml


variables:
  JAVA_BUILDER_BUILD_COMMAND: clean install -DskipTests
  JAVA_BUILDER_OUTPUT_DIR: $CI_PROJECT_DIR
  RUNNER_TAG: sih_public_runner
  APP_SHARED_MODULE: sumaris-core-shared
  APP_CORE_MODULE: sumaris-core
  APP_DB_MODULE: sumaris-db
  APP_WAR_MODULE: sumaris-server
  ARTIFACT_WAR_FILE: $APP_WAR_MODULE/target/*.war
  ARTIFACT_CONFIG_FILES: $APP_WAR_MODULE/target/classes/*.properties
  IFREMER_IMAGE_REGISTRY: gitlab-registry.ifremer.fr/ifremer-commons/docker/images/



container-image:docker:build üê≥:
  script:
    - mkdir -p target/docker/config
    - cp -rf $APP_WAR_MODULE/src/main/docker/run/* target/docker/
    - cp -f $ARTIFACT_WAR_FILE target/docker/app.war
    - cp -f $ARTIFACT_CONFIG_FILES target/docker/config/
    - cd target/docker
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
      - docker buildx build
      --push
      --build-arg BUILDKIT_INLINE_CACHE=1
      --build-arg IMAGE_REGISTRY=$IFREMER_IMAGE_REGISTRY
      --cache-from $CI_REGISTRY_IMAGE
      -t $CI_REGISTRY_IMAGE:$CI_COMMIT_REF_NAME
      -t $CI_REGISTRY_IMAGE
      .
